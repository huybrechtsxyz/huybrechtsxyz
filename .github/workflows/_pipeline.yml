# Build and Deploy Jobs
name: Build and Deploy Jobs

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      initialize:
        required: true
        type: string
      rebuild:
        required: true
        type: string
    secrets:
      MINIO_ROOT_USER:
        required: true
      MINIO_ROOT_PASSWORD:
        required: true
      MINIO_REGION:
        required: true
      KAMATERA_API_KEY:
        required: true
      KAMATERA_API_SECRET:
        required: true
      POSTGRES_USER:
        required: true
      POSTGRES_PASSWORD:
        required: true
      VERSIO_USERNAME:
        required: true
      VERSIO_PASSWORD:
        required: true
      VERSIO_ENDPOINT:
        required: true
      APP_HOST_SERVER:
        required: true
      APP_HOST_PORT:
        required: true
      APP_HOST_USERNAME:
        required: true
      APP_HOST_PASSWORD:
        required: true

jobs:
  initialize-server:
    name: Initialize Server Job
    if: inputs.initialize == 'true'
    uses: huybrechtsxyz/huybrechtsxyz/.github/workflows/_task-initialize.yml@main
    with:
      environment: ${{ inputs.environment }}
    secrets:
      KAMATERA_API_KEY: ${{ secrets.KAMATERA_API_KEY }}
      KAMATERA_API_SECRET: ${{ secrets.KAMATERA_API_SECRET }}

  update-server:
    name: Update Server Job
    uses: huybrechtsxyz/huybrechtsxyz/.github/workflows/_task-update.yml@main
    with:
      environment: ${{ inputs.environment }}
    secrets:
      MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
      MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
      MINIO_REGION: ${{ secrets.MINIO_REGION }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      VERSIO_USERNAME: ${{ secrets.VERSIO_USERNAME }}
      VERSIO_PASSWORD: ${{ secrets.VERSIO_PASSWORD }}
      VERSIO_ENDPOINT: ${{ secrets.VERSIO_ENDPOINT }}
      APP_HOST_SERVER: ${{ secrets.APP_HOST_SERVER }}
      APP_HOST_PORT: ${{ secrets.APP_HOST_PORT }}
      APP_HOST_USERNAME: ${{ secrets.APP_HOST_USERNAME }}
      APP_HOST_PASSWORD: ${{ secrets.APP_HOST_PASSWORD }}

  deploy-config:
    name: Deploy Configuration Job
    needs: [update-server]
    uses: huybrechtsxyz/huybrechtsxyz/.github/workflows/_task_configuration.yml@main
    with:
      environment: ${{ inputs.environment }}
    secrets:
      APP_HOST_SERVER: ${{ secrets.APP_HOST_SERVER }}
      APP_HOST_PORT: ${{ secrets.APP_HOST_PORT }}
      APP_HOST_USERNAME: ${{ secrets.APP_HOST_USERNAME }}
      APP_HOST_PASSWORD: ${{ secrets.APP_HOST_PASSWORD }}

  deploy-stack-rebuild:
    name: Deploy Docker Swarm Stack (Rebuild)
    if: inputs.rebuild == 'true'
    needs: [deploy-config]
    uses: huybrechtsxyz/huybrechtsxyz/.github/workflows/_task-deploy.yml@main
    with:
      environment: ${{ inputs.environment }}
    secrets:
      APP_HOST_SERVER: ${{ secrets.APP_HOST_SERVER }}
      APP_HOST_PORT: ${{ secrets.APP_HOST_PORT }}
      APP_HOST_USERNAME: ${{ secrets.APP_HOST_USERNAME }}
      APP_HOST_PASSWORD: ${{ secrets.APP_HOST_PASSWORD }}

  deploy-stack-nobuild:
    name: Deploy Docker Swarm Stack (Build)
    if: inputs.rebuild != 'true'
    needs: [deploy-config]
    uses: huybrechtsxyz/huybrechtsxyz/.github/workflows/_task-deploy.yml@main
    with:
      environment: ${{ inputs.environment }}
    secrets:
      APP_HOST_SERVER: ${{ secrets.APP_HOST_SERVER }}
      APP_HOST_PORT: ${{ secrets.APP_HOST_PORT }}
      APP_HOST_USERNAME: ${{ secrets.APP_HOST_USERNAME }}
      APP_HOST_PASSWORD: ${{ secrets.APP_HOST_PASSWORD }}
