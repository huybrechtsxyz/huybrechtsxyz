# Docker Compose for the test environment
#
# Environment Variables
# =======================================
# =======================================
#
version: '3.9'

services:

  consul:
    image: consul:1.15.4
    container_name: consul
    command:
      - consul
      - agent
      - -dev
      - -data-dir=/consul/data
      - -config-dir=/consul/config
      - -config-file=/consul/config/consul.develop.json
    networks:
      - public
    volumes:
      - consul-conf:/consul/config
      - consul-data:/consul/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 5s

  traefik:
    image: "traefik:v3.1.6"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    networks:
      - public
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - traefik-conf/traefik.develop.yml:/etc/traefik/traefik.yml:ro
      - traefik-data:/app/data
      - traefik-logs:/app/logs
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s

  minio:
    image: "minio/minio:latest"
    container_name: minio
    environment:
      MINIO_ROOT_USER: "admin"
      MINIO_ROOT_PASSWORD: "password"
      MINIO_REGION: "develop"
      MINIO_HTTP2_DISABLE: "on"
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"  # MinIO Dataservice
      - "9001:9001"  # MinIO Console (optional)
    networks:
      - public
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "--silent", "--fail", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 5s

volumes:

  consul-conf:
    driver: local
    driver_opts:
      type: none
      device: ../.app/consul/conf
      o: bind
  consul-data:
    driver: local
    driver_opts:
      type: none
      device: ../.app/consul/data
      o: bind

  traefik-conf:
    driver: local
    driver_opts:
      type: none
      device: /app/traefik/conf
      o: bind
  traefik-data:
    driver: local
    driver_opts:
      type: none
      device: /app/traefik/data
      o: bind
  traefik-logs:
    driver: local
    driver_opts:
      type: none
      device: /app/traefik/logs
      o: bind

  minio-data:
    driver: local
    driver_opts:
      type: none
      device: /app/minio/data
      o: bind

networks:
  public:
    driver: bridge
  private:
    driver: bridge

#secrets:

#configs:
