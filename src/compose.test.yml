# Docker Compose for the test environment
#
# Environment Variables
# =======================================
# DOCKER_SWARM_MANAGERS
# MINIO_ROOT_USER
# MINIO_ROOT_PASSWORD
# MINIO_REGION
# PGADMIN_USER
# PGADMIN_PASSWORD
# POSTGRES_USER
# POSTGRES_PASSWORD
# VERSIO_USERNAME
# VERSIO_PASSWORD
# VERSIO_ENDPOINT
# =======================================
#
version: '3.9'

services:

  consul:
    image: consul:1.15.4    
    environment:
      SWARM_MANAGERS: ${SWARM_MANAGERS}
    command:
      - consul
      - agent
      - -data-dir=/consul/data
      - -config-dir=/consul/config
      - -config-file=/consul/config/consul.test.json
      - -bootstrap-expect=${SWARM_MANAGERS}
    networks:
      - public
    volumes:
      - consul-conf:/consul/config
      - consul-data:/consul/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 5s
    deploy:
      replicas: ${DOCKER_SWARM_MANAGERS}
      placement:
        constraints: 
          - node.role == manager
        preferences:
          - spread: node.id
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 60s
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 30s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: continue
        monitor: 30s
      # resources:
      #   limits:
      #     cpus: "2.0"     # Max 2 CPUs
      #     memory: "2G"    # Max 2GB of memory
      #   reservations:
      #     cpus: "0.5"     # Reserve 0.5 CPUs
      #     memory: "512M"  # Reserve 512MB of memory

  traefik:
    image: "traefik:v3.1.6"
    secrets:
      - VERSIO_USERNAME
      - VERSIO_PASSWORD
      - VERSIO_ENDPOINT
    environment:
      VERSIO_USERNAME_FILE: /run/secrets/VERSIO_USERNAME
      VERSIO_PASSWORD_FILE: /run/secrets/VERSIO_PASSWORD
      VERSIO_ENDPOINT_FILE: /run/secrets/VERSIO_ENDPOINT
    ports:
      - "80:80"
      - "443:443"
    networks:
      - public
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - traefik-conf/traefik.test.yml:/etc/traefik/traefik.yml:ro
      - traefik-data:/app/data
      - traefik-logs:/app/logs
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      replicas: 1
      placement:
        constraints: 
          - node.role == manager
        preferences:
          - spread: node.id
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 60s
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 30s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: continue
        monitor: 30s
      # resources:
      #   limits:
      #     cpus: "1.0"     # Max 1 CPUs
      #     memory: "512M"  # Max 512Mb of memory
      #   reservations:
      #     cpus: "0.25"    # Reserve 0.25 CPUs
      #     memory: "512M"  # Reserve 512MB of memory

  minio:
    image: "minio/minio:latest"
    secrets:
      - MINIO_ROOT_USER
      - MINIO_ROOT_PASSWORD
      - MINIO_REGION
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/MINIO_ROOT_USER
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/MINIO_ROOT_PASSWORD
      MINIO_REGION_FILE: /run/secrets/MINIO_REGION
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"  # MinIO API
      - "9001:9001"  # MinIO Console
    networks:
      - public
    volumes:
      - minio-dat:/data
    healthcheck:
      test: ["CMD", "curl", "--silent", "--fail", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      replicas: 1
      placement:
        constraints: 
          - node.role == worker
        preferences:
          - spread: node.id
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 30s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: continue
        monitor: 30s
      # resources:
      #   limits:
      #     cpus: "1.5"
      #     memory: "3G"
      #   reservations:
      #     cpus: "1.0"
      #     memory: "2G"

  minio-init:
    image: minio/mc
    secrets:
      - MINIO_ROOT_USER
      - MINIO_ROOT_PASSWORD
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/MINIO_ROOT_USER
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/MINIO_ROOT_PASSWORD
    entrypoint: >
      /bin/sh -c "
        # Function to create bucket if it doesn't exist and set the read-write policy
        create_bucket_if_not_exists() {
          local bucket_name=\$1
          echo 'Checking if bucket' \$bucket_name 'exists...';
          if ! mc ls myminio/\$bucket_name > /dev/null 2>&1; then
              echo 'Creating bucket' \$bucket_name '...';
              mc mb myminio/\$bucket_name || { echo 'Failed to create bucket'; exit 1; }
              echo 'Created bucket' \$bucket_name
          else
              echo 'Bucket' \$bucket_name 'already exists'
          fi &&
          
          echo 'Setting read-write policy for' \$bucket_name 'bucket...';
          mc anonymous set public myminio/\$bucket_name || { echo 'Failed to set policy'; exit 1; }
          echo 'Set read-write policy for' \$bucket_name 'bucket'
        }

        # Main script execution
        echo 'Setting MinIO alias...';
        export MINIO_ROOT_USER=\$(cat \$MINIO_ROOT_USER_FILE)
        export MINIO_ROOT_PASSWORD=\$(cat \$MINIO_ROOT_PASSWORD_FILE)
        echo \$MINIO_ROOT_USER;
        echo \$MINIO_ROOT_PASSWORD;
        mc alias set myminio http://minio:9000 \$MINIO_ROOT_USER \$MINIO_ROOT_PASSWORD &&

        # Create and configure buckets
        create_bucket_if_not_exists thanos;
        create_bucket_if_not_exists loki;
      "
    networks:
      - public

  postgres:
    image: postgres
    secrets:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_DB: xyzdb
      POSTGRES_USER_FILE: /run/secrets/POSTGRES_USER
      POSTGRES_PASSWORD_FILE: /run/secrets/POSTGRES_PASSWORD
    networks:
      - traefik
    volumes:
      - /app/data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d xyzdb -U admin"]
      interval: 1s
      timeout: 5s
      retries: 10
      start_period: 5s
    deploy:
      replicas: 1
      placement:
        constraints: 
          - node.role == worker
        preferences:
          - spread: node.id
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 60s
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 30s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: continue
        monitor: 30s
      # resources:
      #   limits:
      #     cpus: "2.0"     # Max 2 CPUs
      #     memory: "2G"    # Max 2GB of memory
      #   reservations:
      #     cpus: "0.5"     # Reserve 0.5 CPUs
      #     memory: "512M"  # Reserve 512MB of memory

  pgadmin:
    image: dpage/pgadmin4
    secrets:
      - PGADMIN_USER
      - PGADMIN_PASSWORD
    environment:
      PGADMIN_LISTEN_PORT: 9080
      PGADMIN_DEFAULT_EMAIL_FILE: PGADMIN_USER
      PGADMIN_DEFAULT_PASSWORD_FILE: PGADMIN_PASSWORD
      SCRIPT_NAME: /pgadmin
    networks:
      - public
      - private
    volumes:
      - postgres-admin:/var/lib/pgadmin
    healthcheck:
      test: ["CMD", "curl", "--silent", "--fail", "http://localhost:9080/pgadmin"]
      interval: 15s
      retries: 3
      timeout: 10s
      start_period: 10s
    deploy:
      replicas: 1
      placement:
        constraints: 
          - node.role == worker
        preferences:
          - spread: node.id
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 60s
      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 30s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: continue
        monitor: 30s
      # resources:
      #   limits:
      #     cpus: "2.0"     # Max 2 CPUs
      #     memory: "2G"    # Max 2GB of memory
      #   reservations:
      #     cpus: "0.5"     # Reserve 0.5 CPUs
      #     memory: "512M"  # Reserve 512MB of memory

volumes:

  consul-conf:
    driver: local
    driver_opts:
      type: none
      device: /app/consul/conf
      o: bind
  consul-data:
    driver: local
    driver_opts:
      type: none
      device: /app/consul/data
      o: bind

  traefik-conf:
    driver: local
    driver_opts:
      type: none
      device: /app/traefik/conf
      o: bind
  traefik-data:
    driver: local
    driver_opts:
      type: none
      device: /app/traefik/data
      o: bind
  traefik-logs:
    driver: local
    driver_opts:
      type: none
      device: /app/traefik/logs
      o: bind

  minio-data:
    driver: local
    driver_opts:
      type: none
      device: /mnt/data
      o: bind

  postgres-admin:
    driver: local
    driver_opts:
      type: none
      device: /app/postgres/admin
      o: bind
  postgres-data:
    driver: local
    driver_opts:
      type: none
      device: /app/postgres/data
      o: bind

networks:
  public:
    external: true
  private:
    external: true

secrets:
  VERSIO_USERNAME:
    external: true
  VERSIO_PASSWORD:
    external: true
  VERSIO_ENDPOINT:
    external: true

  MINIO_ROOT_USER:
    external: true
  MINIO_ROOT_PASSWORD:
    external: true
  MINIO_REGION:
    external: true

  POSTGRES_USER:
    external: true
  POSTGRES_PASSWORD:
    external: true
  PGADMIN_USER:
    external: true
  PGADMIN_PASSWORD:
    external: true

#configs:
